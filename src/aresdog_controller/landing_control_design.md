# 着陆控制设计 —— 机器人平稳落地方案

*草稿 – 2025-07-16*

---

## 1. 目标
1. **可靠检测触地 (Touch-Down, TD)**：利用实时电机力矩反馈判断机器人足端接触地面。
2. **生成平滑的前馈力矩曲线**：在落地瞬间吸收冲击并过渡到稳定站立。
3. **轻量、板载实现**：算法全部在上位机 ROS 2 节点内完成，兼容现有 `usb_bridge_node` 数据流（`/joint_state`, `/torque_cmd`）。

---

## 2. 状态机概览
```
           ┌─────────┐   触地检测   ┌──────────┐   稳定完成   ┌──────────┐
起跳完成──▶│  空   中 │───────────▶│  冲   击  │───────────▶│  站   立  │
           └─────────┘              └──────────┘              └──────────┘
```
* **空中 (FLIGHT)**   – 四足离地，前馈力矩为 0。
* **冲击 (IMPACT)**   – 从第一只腿触地到垂直冲击耗散结束。
* **站立 (STANDING)** – 切换至平衡 / 支撑控制器维持站姿。

落地控制器负责 **FLIGHT → IMPACT → STANDING** 两个转换。

---

## 3. 触地检测算法
1. **信号来源**：`/joint_state` 消息中的 `effort` 字段（来自 `0x0203` MotorState-T 实际力矩反馈）。
2. **预处理**：对每条力矩信号做一阶低通滤波（截止频率约 50 Hz）。
3. **判据指标**：力矩绝对值及其一阶差分
   $$ \dot\tau_i = |\tau_i(t) - \tau_i(t-Δt)| / Δt $$
4. **TD 条件**：至少 *N_contact* (≥2) 条腿同时满足
   $$ |\tau_i| > τ_{th} \quad \textbf{且}\quad \dot\tau_i > \dotτ_{th} $$
   * 默认参数：`τ_th = 3 N·m`，`dotτ_th = 30 N·m/s`。
5. **去抖**：TD 条件需持续 ≥2 个采样周期才确认触地。

---

## 4. 冲击吸收前馈力矩曲线
触地后按时间推进四个阶段：
| 阶段 | 时段 | 作用 | 描述 |
|------|------|------|------|
| Phase-0 | 0~Δt0 (≈20 ms) | 预加刚度 | 线性将力矩从 0 升至 `τ_peak` |
| Phase-1 | Δt0~Δt1 | 主动阻尼 | 维持 `τ_peak` 并叠加 PD（依据关节压缩量） |
| Phase-2 | Δt1~Δt2 | 释放阶段 | 指数衰减 `τ = τ_peak · e^{−k (t−Δt1)}`，`k≈30 s⁻¹` |
| Phase-3 | ≥Δt2   | 站立接管 | 切换给现有平衡/站立控制器 |

所有参数通过 ROS 2 `parameter` 暴露，便于在线调节。

---

## 5. ROS 2 接口
| 话题 | 消息类型 | 方向 | 说明 |
|------|----------|------|------|
| `/joint_state` | sensor_msgs/JointState | 订阅 | 读取 `effort` 进行触地检测 |
| `/torque_cmd`  | sensor_msgs/JointState | 发布 | 发布 MIT 控制模式的前馈力矩 |
| `/landing_state` | std_msgs/String | 发布 | 当前状态：`FLIGHT`、`IMPACT`、`STANDING` |

> 节点运行频率：500 Hz（与 IMU 同步），保证触地检测精度。

---

## 6. 实现步骤
1. **节点骨架** (`landing_controller.cpp` / `.py`)
   * 继承 `rclcpp::Node`。
   * 订阅 `/joint_state`，发布 `/torque_cmd`、`/landing_state`。
2. **滤波与缓冲**：为每个关节维护 5 长度环形缓冲做差分。
3. **状态机逻辑**：实现第 2 节转换条件。
4. **力矩曲线生成器**：根据时间戳查表输出每条腿目标力矩。
5. **集成**：起跳时由 `JumpController` 激活落地控制器，或在空中阶段自动检测低力矩进入待机。
6. **测试流程**：Gazebo → 台架 → 整机实测。

---

## 7. 参数默认值
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `tau_th` | 3.0 | 力矩阈值 (N·m) |
| `dot_tau_th` | 30.0 | 力矩导数阈值 (N·m/s) |
| `tau_peak` | 8.0 | 触地后峰值前馈力矩 (N·m) |
| `dt0` | 0.02 | Phase-0 持续时间 (s) |
| `k_decay` | 30.0 | Phase-2 指数衰减速率 (s⁻¹) |

---

## 8. 后续工作
* 基于 IMU 垂直加速度的自适应阈值。
* 利用强化学习 / MPC 优化力矩曲线。
* 与步态调度器结合，支持跑跳落地。 